---
/**
 * Trang chi tiết sản phẩm theo glt_slug
 * Tạo static paths từ danh sách sản phẩm lấy từ PUBLIC_API_URL
 */

import Layout from '../../layouts/Layout.astro';
import ProductDetailIsland from '../../components/ProductDetailIsland.tsx';
import { getProducts } from '../../lib/api';
import type { Product, ProductResponse } from '../../types/product';

interface Props {
  product: Product;
}

export async function getStaticPaths() {
  const data = (await getProducts()) as ProductResponse;
  const products = data.products_data || [];

  // Lọc những sản phẩm có glt_slug hợp lệ
  const itemsWithSlug = products.filter((p) => Boolean(p.glt_slug));

  return itemsWithSlug.map((p) => ({
    params: { slug: p.glt_slug as string },
    props: { product: p },
  }));
}

const { product } = Astro.props as Props;

function getProductImage(product: Product): string {
  // Ưu tiên main image từ glt_images
  if (product.glt_images && product.glt_images.length > 0) {
    const mainImage = product.glt_images.find(img => img.role === 'main');
    if (mainImage) {
      return mainImage.url;
    }
    // Fallback: lấy ảnh đầu tiên
    return product.glt_images[0].url;
  }
  return 'https://via.placeholder.com/800x600?text=No+Image';
}
---

<Layout title={`${product.full_name} - Gạo Lâm Thúy`} description={`Chi tiết sản phẩm ${product.full_name}`}>
  <nav slot="breadcrumb" class="breadcrumbs text-sm px-4 pt-4" aria-label="Breadcrumb">
    <ul>
      <li><a href="/">Trang chủ</a></li>
      <li><a href="/products">Sản phẩm</a></li>
      {product.category_name && (
        <li><a href={`/products?category=${encodeURIComponent(product.category_name)}`}>{product.category_name}</a></li>
      )}
      <li aria-current="page">{product.name}</li>
    </ul>
  </nav>
  <div slot="breadcrumb" class="px-4 pt-2">
    <a
      href="/products"
      class="btn btn-ghost btn-sm"
      onclick="if (document.referrer) { history.back(); return false; }"
      aria-label="Quay lại trang trước"
    >
      ← Quay lại
    </a>
  </div>
  <main class="container mx-auto px-4 py-6">
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
      <!-- Hình ảnh lớn - sẽ được ProductDetailIsland quản lý -->
      <div id="product-image-container">
        <img src={getProductImage(product)} alt={product.name} class="w-full rounded-xl shadow-md" loading="eager" id="main-product-image" />
      </div>

      <!-- Thông tin sản phẩm -->
      <div class="space-y-4">
        <div class="space-y-2">
        <h1 class="text-2xl font-extrabold text-base-content">{product.name}</h1>
            
          <div class="flex items-center gap-2 flex-wrap">
            <div class="badge badge-outline">{product.category_name}</div>
            {product.glt_retail_promotion && (
              <div class="tooltip" data-tip="Giảm 10,000VNĐ/10kg cho đơn hàng dưới 50kg">
                <div class="badge badge-outline flex items-center gap-1">
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32" fill="currentColor" class="w-4 h-4">
                    <path d="M 16 3 C 8.832031 3 3 8.832031 3 16 C 3 23.167969 8.832031 29 16 29 C 23.167969 29 29 23.167969 29 16 C 29 8.832031 23.167969 3 16 3 Z M 16 5 C 22.085938 5 27 9.914063 27 16 C 27 22.085938 22.085938 27 16 27 C 9.914063 27 5 22.085938 5 16 C 5 9.914063 9.914063 5 16 5 Z M 15 10 L 15 12 L 17 12 L 17 10 Z M 15 14 L 15 22 L 17 22 L 17 14 Z"></path>
                  </svg>
                  Khuyến mãi
                </div>
              </div>
            )}
            {product.child_product && (
                <div class="badge badge-outline flex items-center gap-1">
                  Nhiều loại
              </div>
            )}
          </div>
          
        </div>

        <ProductDetailIsland client:visible product={product} />

        <div class="flex gap-3 pt-2">
          <a href="https://zalo.me/0901467300" class="btn btn-primary">
            Liên hệ
          </a>
          {product.glt_kiotvietshop_url && (
            <a href={product.glt_kiotvietshop_url} target="_blank" rel="noopener noreferrer" class="btn btn-primary btn-outline">
              Đặt hàng online
            </a>
          )}
          {product.glt_shopee_url && (
            <a href={product.glt_shopee_url} target="_blank" rel="noopener noreferrer" class="btn">
              Xem trên Shopee
            </a>
          )}
        </div>


        <!-- <div class="text-xs text-base-content/50 pt-4">
          Mã hàng: {product.code} • ID: {product.id}
        </div> -->
      </div>
    </div>

    <!-- Gợi ý sản phẩm liên quan (đơn giản: cùng danh mục) -->
    <!-- Có thể mở rộng trong tương lai: fetch thêm và loại trừ chính mình -->
  </main>
</Layout>


